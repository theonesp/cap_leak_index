---
title: "01_dataset_creation"
author: "Jay Chandra & Miguel √Ångel Armengol"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_notebook:
    code_folding: hide
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes

knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4)," ",Sys.Date(),'.html')) })
---

# Environment

```{r message=FALSE, warning=FALSE}
library(bigrquery)
library(summarytools)
library(readr)
library(stringr)
library(sqldf)
library(dplyr)
library(tableone)
library(Hmisc)
library(kableExtra)
library(caret)
library(plotly)
library(table1)

winsorize_x = function(x, cut = 0.05){
  cut_point_top <- quantile(x, 1 - cut, na.rm = T)
  cut_point_bottom <- quantile(x, cut, na.rm = T)
  i = which(x >= cut_point_top) 
  x[i] = cut_point_top
  j = which(x <= cut_point_bottom) 
  x[j] = cut_point_bottom
  return(x)
}
```


# Set up BigQuery related functions

This chunks also creates the run_query and get_sql function.

```{r setup, include=FALSE}
# Updated for our year
project_id <- "hst-953-2019"
options(httr_oauth_cache=FALSE)
# Function that takes in a sql command and runs it on bigquery
run_query <- function(query){
  data <- query_exec(query, project=project_id, use_legacy_sql=FALSE,max_pages = Inf)
  return(data)
}

# function for reading sql files
getSQL <- function(filepath){
  con = file(filepath, "r")
  sql.string <- ""

  while (TRUE){
    line <- readLines(con, n = 1)

    if ( length(line) == 0 ){
      break
    }

    line <- gsub("\\t", " ", line)

    if(grepl("--",line) == TRUE){
      line <- paste(sub("--","/*",line),"*/")
    }

    sql.string <- paste(sql.string, line)
  }

  close(con)
  return(sql.string)
}

'%!in%' <- function(x,y)!('%in%'(x,y))
```

# Loading queries and extracting the data

Loads all queries from the sql files in the extraction folder and runs them into RBigQuery to extract the data.

```{r}
amsterdam = run_query(getSQL("sql/amsterdam 2.sql" ))
```

```{r}
charlson = run_query(getSQL("sql/charlson 2.sql" ))
```


```{r}
sofa = run_query(getSQL("sql/sofa_final.sql" ))
```

```{r}
# Sepsis patients
sepsis <- run_query(getSQL('sql/sepsis.sql'))

# List of patients that are bleeding we want to exclude.
patient_inexcluded_icd9 <- run_query(getSQL('sql/patient_inexcluded_icd9.sql'))

#exclude patients who have recieved blood (I don't think we are doing this in eicu or mimic)
blood_infus <- run_query(getSQL('sql/blood_infus.sql'))

#72hr Fluid Data
fluid_72hrs <- run_query(getSQL('sql/fluid_72hrs.sql'))

#Renal Replacement Therapy
rrt <- run_query(getSQL('sql/RRT.sql'))
```

# Exclusion criteria 1

Patients with sepsis (not bleeding)

```{r}
# we want to include septic patients that are not bleeding.

print('Septic patients:')
nrow(sepsis)

print('Patients bleeding')
nrow(patient_inexcluded_icd9)

patient_included_vector <- sepsis[sepsis$admissionid %!in% patient_inexcluded_icd9$admissionid  ,]
patient_included <- data.frame(patientunitstayid=integer(length(patient_included_vector))) 
patient_included$patientunitstayid<-patient_included_vector

print('Septic patients that are not bleeding')
nrow(patient_included)

```


# Exclusion criteria 2 and JOIN

Exclusion criteria and dataset join and not getting rrt (we need new datasets to address exclusion criteria)

```{r}
names(amsterdam)[1] <- "admissionid"
names(patient_included)[1] <- "admissionid"
selected_cohort<-inner_join(amsterdam,patient_included)
print('Patients >=16 years old:')
nrow(selected_cohort)

selected_cohort<-sqldf('
SELECT * FROM
selected_cohort
LEFT JOIN
rrt
USING
(admissionid)
WHERE
rrt.admissionid IS NULL
')

print('Patients not recieving rrt:')
nrow(selected_cohort)

# We are using a left join to join them
vol_leak_index_dataset<-Reduce(function(...) merge(..., all.x=TRUE), list(
   selected_cohort
   ,fluid_72hrs
  ,charlson
))

# We are adding mech vent status
vol_leak_index_dataset<-vol_leak_index_dataset%>%
  mutate(
    mech_vent = ifelse(unabridgedactualventdays > 0, 1, 0)
  )  
vol_leak_index_dataset$mech_vent[is.na(vol_leak_index_dataset$mech_vent)] = 0
# Removes Patients without intake data
vol_leak_index_dataset<-sqldf('
SELECT * FROM
vol_leak_index_dataset
WHERE intakes IS NOT null')

print('patients with fluid data')
nrow(vol_leak_index_dataset)

# Ensures fluid balance is positive.
vol_leak_index_dataset<-sqldf('
SELECT * FROM
vol_leak_index_dataset
WHERE totalFluid > 0 ')

print('patients with positive fluid data')
nrow(vol_leak_index_dataset)
# Alter fluid data so all is positive
```

## Creating new variables

### Leaking Index

```{r}
vol_leak_index_dataset<-vol_leak_index_dataset%>%
  mutate(
    leaking_index=((mean_hct_24_36hrs - first_hct_6hrs) / totalFluid) * body_surface_area * 1561
  )  
```

### Addressing outliers

```{r eval=FALSE, include=FALSE}

# We are removing VLI outliers
# We are imputing anything outside the 95% interval
extreme_quants<-as.numeric(quantile(vol_leak_index_dataset$leaking_index, c(.05, .975),na.rm = T))

print('Number of patients with imputed data:')
length(which(vol_leak_index_dataset$leaking_index< extreme_quants[1] | vol_leak_index_dataset$leaking_index> extreme_quants[2]))

medLeak = median(vol_leak_index_dataset$leaking_index, na.rm = T)
vol_leak_index_dataset$leaking_index[which(vol_leak_index_dataset$leaking_index< extreme_quants[1] | vol_leak_index_dataset$leaking_index> extreme_quants[2])] = medLeak
```

## SOFA Delta Description

|                   | Sofa day 2 No change | Sofa day 2 Increases | Sofa day 2 Decreases |
|-------------------|----------------------|----------------------|----------------------|
| High Sofa day 1   | Bad                  | Bad                  | Good                 |
| Medium Sofa day 1 | Bad                  | Bad                  | Good                 |
| Low Sofa day 1    | Good                 | Bad                  | Good                 |

0 Means GOOD Oucome, 1 means BAD Outcome

# Creating and Altering Variable
```{r}

# amsterdam$age_fixed = as.factor(amsterdam$age_fixed)
# amsterdam$gender[amsterdam$gender=='Male']<-1
# amsterdam$gender[amsterdam$gender=='Female']<-2
vol_leak_index_dataset$hosp_mortality = vol_leak_index_dataset$actualhospitalmortality * 1
vol_leak_index_dataset$q_leaking_index = as.factor(ntile(vol_leak_index_dataset$leaking_index,4))

# age_grouper = function(age) {
#   if (age >=18 & age <=39) {
#     group = '18-39'
#   } else if (age >=40 & age <= 49) {
#     group = '40-49'
#   } else if (age >=50 & age <=59) {
#     group = '50-59'
#   } else if (age >= 60 & age <= 69) {
#     group = '60-69'
#   } else if (age >= 70 & age <= 79) {
#     group = '70-79'
#   } else if (age >= 80) {
#     group = '80+'
#   } else {
#     group = NA
#   }
#   return(group)
# }
```

## Selecting/Imputing/removing data

```{r}
selected_df_fluid <- vol_leak_index_dataset%>%dplyr::select(
     admissionid
    ,hosp_mortality
    ,age_fixed
    ,gender
    ,charlson_score
    # ,apachescore
    # ,delta_sofa
    ,hosp_mortality_offset
    ,totalFluid
    ,totalFluid_72
    # ,highest_q_leaking_index
    ,q_leaking_index
    ,leaking_index
    ,first_hct_6hrs
    ,mean_hct_24_36hrs
    , unabridgedunitlos
    , unabridgedhosplos
    ,mech_vent
    , unitType
  )

selected_df_fluid<-selected_df_fluid[complete.cases(selected_df_fluid),]
print('Number of patients after removing incomplete data:')
nrow(selected_df_fluid)

# Removing Patients who died before 72 hours
# selected_df_fluid<-selected_df_fluid%>%filter(hosp_mortality_offset>72 | hosp_mortality_offset==0)
# print('Number of patients after excluding patients with hosp_mort_offset <72hrs:')
# nrow(selected_df_fluid)

selected_df_fluid<-selected_df_fluid%>%mutate(totalFluid_72_bin = ifelse(totalFluid_72 > 0, 1, 0))

# selected_df$highest_q_leaking_index<-as.factor(selected_df$highest_q_leaking_index)

```

Amsterdam DB Cohort Information:

- Total patients in Amsterdam UMC DB: 23172
- After excluding patients without diagnosis of sepsis (n=9936): 13236
- After excluding patients with diagnosis of bleeding (n=4992): 8244
- After excluding patients who received blood/colloids (n=1757): 6487
- After excluding patients with missing CLI variables (n=4341): 2146
- After excluding patients with missing delta SOFA (n=1728): 418
(not using Apache because only 4869 patients in the entire dataset have apache)


# Table 1

```{r}
# table1(~ age_fixed + hosp_mortality + gender + charlson_score + apachescore + totalFluid + mean_hct_24_36hrs + first_hct_6hrs| q_leaking_index, data=selected_df)

table1(~ gender + age_fixed + hosp_mortality + totalFluid + totalFluid_72 + mean_hct_24_36hrs + first_hct_6hrs + charlson_score| q_leaking_index, data=selected_df_fluid)
```
## Summary of dataset
```{r}
view(dfSummary(selected_df_fluid))
```

## Final Histogram of Fluid Balance
```{r}
hist(selected_df_fluid$totalFluid, breaks = 50, xlim = c(0, 10000))
```
```{r}
hist(selected_df_fluid$totalFluid_72, breaks = 50)
```


```{r}
vars_in_table1<-c('age_fixed', 'gender'  , 'charlson_score', 'totalFluid' , 'mean_hct_24_36hrs' , 'first_hct_6hrs', 'hosp_mortality','leaking_index', 'unabridgedunitlos', 'unabridgedhosplos', 'mech_vent')

table1_dataset<-selected_df_fluid[,vars_in_table1]

cat_variables<-rep(NA, length(vars_in_table1))
stratifyby<-"hosp_mortality"


label(table1_dataset$age_fixed)<-'Age'

# detects whether a variable is categorical or not
cont<-1
for (i in 1:length(vars_in_table1) ) {
  if ( n_distinct(table1_dataset[vars_in_table1[i] ])<=10 ) {
    print(i)
    print(vars_in_table1[i])
    print(names(table1_dataset[vars_in_table1[i]]))
    cat_variables[cont]<-names(table1_dataset[vars_in_table1[i]])
    cont<-cont+1
  }
}  

cat_variables<-cat_variables[!is.na(cat_variables)]

table1_base<-print(CreateTableOne(vars = vars_in_table1, strata = stratifyby, factorVars = cat_variables
    ,data = table1_dataset, addOverall=T),varLabels = T)

# run this in console for html output, the code below uses kableExtra::

starification_cats<-n_distinct(table1_dataset[,stratifyby])

table1_base %>%
  kbl(caption = "Table 1 of base model" , align = "c") %>%
  kable_classic_2(full_width = F, html_font = "Cambria")%>%
  add_header_above(c(" "," ", 'Hospital Mortality' = starification_cats," ", "" ))
```


