---
title: "02_training_model"
author: "Miguel √Ångel Armengol & Jay Chandra"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_notebook:
    code_folding: hide
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float: yes

knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = paste0(substr(inputFile,1,nchar(inputFile)-4)," ",Sys.Date(),'.html')) })
---

# Environment

```{r}
library(mgcv)
library(ggplot2)
library(mgcViz)
```

```{r}
ggplot(selected_df, aes(leaking_index,hosp_mortality) ) +
  stat_smooth()

ggplot(selected_df_fluid, aes(leaking_index,totalFluid_72) ) +
  stat_smooth()
```

# GAM analysis Fluid Balance

```{r}
# Build the model
model <- gam(totalFluid_72 ~ 
                s(leaking_index)
                + age_fixed
                + gender
                + charlson_score
                ,data=selected_df_fluid)
# Make predictions
predictions <- model %>% predict(selected_df_fluid)

summary(model)
# Model performance
data.frame(
  RMSE = RMSE(predictions, selected_df_fluid$totalFluid_72),
  R2 = R2(predictions, selected_df_fluid$totalFluid_72)
)

ggplot(selected_df_fluid, aes(leaking_index, totalFluid_72) ) +
  stat_smooth(method = gam, formula = y ~ s(x)) +
  ggtitle("GAM Model for Leaking Index and Fluid Balance 72hrs") +
  labs(y="Fluid Balance 72hrs", x = "Leaking Index")
```

```{r}
# Build the model
model <- gam(totalFluid_72_bin ~ 
                s(leaking_index)
                +totalFluid
                + age_fixed
                + gender
                + charlson_score
                ,data=selected_df_fluid)
# Make predictions
predictions <- model %>% predict(selected_df_fluid)

summary(model)
# Model performance
data.frame(
  RMSE = RMSE(predictions, selected_df_fluid$totalFluid_72_bin),
  R2 = R2(predictions, selected_df_fluid$totalFluid_72_bin)
)

ggplot(selected_df_fluid, aes(leaking_index, totalFluid_72_bin) ) +
  stat_smooth(method = gam, formula = y ~ s(x)) +
  ggtitle("GAM Model for Leaking Index and Fluid Balance 72hrs") +
  labs(y="Fluid Balance 72hrs", x = "Leaking Index")
```

